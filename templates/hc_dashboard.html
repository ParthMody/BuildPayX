<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BuildPayX</title>
  <link rel="icon" href="{{ url_for('static', filename='assets/favicon.ico') }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/bootstrap.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/vendors/bootstrap-icons/bootstrap-icons.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/app.css') }}" />
  <link rel="shortcut icon" href="{{ url_for('static', filename='assets/images/favicon.svg') }}" type="image/x-icon" />
  <style>
    .text-brown { color: #a86d32; }
  </style>
<style>
  /* New: Make text in status and risk tag columns strongly visible */
  .table-status-text {
    color: #212529 !important;          /* Very dark gray, always readable */
    font-weight: 600 !important;        /* Emphasized for status */
    text-shadow: 0 1px 2px #fff8;       /* Subtle shadow for contrast */
    letter-spacing: 0.01em;
  }
  .table-risk-text {
    color: #212529 !important;          /* Same for risk tag */
    font-weight: 700 !important;
    text-shadow: 0 1px 2px #fff8;
    letter-spacing: 0.01em;
  }
</style>

</head>
<body>
  <div id="app">
    <div id="sidebar" class="active">
      <div class="sidebar-wrapper active">
        <div class="sidebar-header">
          <div class="d-flex justify-content-between">
            <div class="logo">
              <a href="#"><img style="width: 200px; height: 70px;" src="{{ url_for('static', filename='assets/images/logo/logo.png') }}" alt="Logo" /></a>
            </div>
            <div class="toggler">
              <a href="#" class="sidebar-hide d-xl-none d-block"><i class="bi bi-x bi-middle"></i></a>
            </div>
          </div>
        </div>
        <div class="sidebar-menu">
          <ul class="menu">
            <li class="sidebar-title">Menu</li>
            <li class="sidebar-item active">
              <a href="{{ url_for('hc_dashboard') }}" class="sidebar-link">
                <i class="bi bi-grid-fill"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li class="sidebar-title">Pages</li>
            <li class="sidebar-item">
              <a href="{{ url_for('subcontractors_list') }}" class="sidebar-link">
                <i class="bi bi-people-fill"></i>
                <span>Subcontractors</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a href="{{ url_for('head_po_overview') }}" class="sidebar-link">
                <i class="bi bi-chat-right-text-fill"></i>
                <span>PO Overview</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a href="{{ url_for('head_notifications') }}" class="sidebar-link">
                <i class="bi bi-person-circle"></i>
                <span>Notifications</span>
              </a>
            </li>
            </li>
            <li class="sidebar-item mt-4 pt-2 border-top">
              <a href="{{ url_for('logout') }}" class="sidebar-link">
                <i class="bi bi-box-arrow-right text-danger"></i>
                <span class="text-danger">Logout</span>
              </a>
            </li>
          </ul>
        </div>
        <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
      </div>
    </div>
      <!-- Main Content -->
      <div id="main">
        <header class="mb-3">
          <a href="#" class="burger-btn d-block d-xl-none"><i class="bi bi-justify fs-3"></i></a>
        </header>

        <div class="page-heading">
          <h3>Head Contractor Overview</h3>
        </div>

        <div class="page-content">
          <section class="row">
            <!-- Analytics Cards -->
            <div class="col-12 col-md-9">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Total POs Under Management</h5>
                      <h2>{{ total_pos|default(0) }}</h2>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Red-Flagged POs</h5>
                      <h2 class="text-danger">{{ red_pos|default(0) }}</h2>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mt-4">
                <div class="card-header"><h4>PO Distribution by Subcontractor</h4></div>
                <div class="card-body">
                  <div id="chart-po-distribution"></div>
                </div>
              </div>

              <div class="card mt-4">
                <div class="card-header"><h4>Subcontractor PO Listings</h4></div>
                <div class="card-body p-2">
                  {% if grouped_pos and grouped_pos|length > 0 %}
                    {% for group in grouped_pos %}
                      <h5 class="mt-3 mb-1"><i class="bi bi-person-badge"></i> {{ group.subcontractor }}</h5>
                      <table class="table table-striped table-sm table-bordered">
                        <thead>
                          <tr>
                            <th>PO #</th>
                            <th>Supplier</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Risk Tag</th>
                            <th>Amount</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for po in group.pos %}
                            <tr>
                              <td>{{ po['po_number'] }}</td>
                              <td>{{ po['supplier'] }}</td>
                              <td>{{ po['description'] }}</td>
                              <td class="{{ status_class(po['status']) }} table-status-text">
                                <i class="bi {{ status_icon(po['status']) }}"></i> {{ po['status'] }}
                              </td>
                              <td class="{{ scenario_class(po['scenario_tag']) }} table-risk-text">
                                <i class="bi {{ scenario_icon(po['scenario_tag']) }}"></i> {{ po['scenario_tag']|capitalize }}
                              </td>
                              <td>${{ '%.2f'|format(po['amount']) }}</td>
                            </tr>
                          {% endfor %}
                          {% if group.pos|length == 0 %}
                            <tr><td colspan="6" class="text-center text-muted">No POs uploaded by this subcontractor.</td></tr>
                          {% endif %}
                        </tbody>
                      </table>
                    {% endfor %}
                  {% else %}
                    <div class="text-center text-muted">No subcontractors found or no POs uploaded.</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Profile & Risk Summary -->
            <div class="col-12 col-md-3">
              <div class="card">
                <div class="card-body py-4 px-5 d-flex align-items-center">
                  <div class="avatar avatar-xl">
                    <img src="{{ url_for('static', filename='assets/images/faces/2.jpg') }}" alt="Head Contractor Avatar" />
                  </div>
                  <div class="ms-3 name">
                    <h5 class="font-bold">{{ session.get('username', 'Head Contractor') }}</h5>
                    <h6 class="text-muted mb-0">Head Contractor</h6>
                  </div>
                </div>
              </div>
              <div class="card mt-3">
                <div class="card-header"><h4>Retention Risk Summary</h4></div>
                <div class="card-body"><div id="head-retention-risk-chart"></div></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- JS Libraries -->
    <script src="{{ url_for('static', filename='assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/vendors/apexcharts/apexcharts.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/main.js') }}"></script>

    <!-- ApexCharts Visualization -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Defensive: Always provides arrays for chart data
        const seriesData = {{ po_counts|default([])|tojson }};
        const labelData = {{ subcontractor_names|default([])|tojson }};
        const riskScore = {{ retention_score|default(68)|int }};

        // PO Distribution donut chart
        var poChart = new ApexCharts(document.querySelector("#chart-po-distribution"), {
          series: seriesData,
          chart: { type: 'donut', height: 280 },
          labels: labelData,
          colors: ['#4caf50', '#ff9800', '#f44336', '#03a9f4'],
          responsive: [{
            breakpoint: 480,
            options: { chart: { width: 200 }, legend: { position: 'bottom' } }
          }]
        });
        poChart.render();

        // Radial bar retention risk chart
        var retentionChart = new ApexCharts(document.querySelector("#head-retention-risk-chart"), {
          series: [riskScore],
          chart: { type: 'radialBar', height: 250 },
          plotOptions: {
            radialBar: {
              hollow: { size: '60%' },
              dataLabels: {
                value: { fontSize: '22px', show: true },
                name: { offsetY: -10, fontSize: '14px', color: '#999' }
              }
            }
          },
          labels: ['Risk Score'],
          colors: ['#ff7043']
        });
        retentionChart.render();
      });
    </script>
  </body>
  <footer class="text-center py-3 bg-white border-top mt-5" style="font-size: 0.97rem; color: #6c757d;">
    © 2025 BuildPayX
    <!-- other links... -->
  </footer>
  </html>
